---
layout: post
title: 计算机网络笔记
date: 2023-6-15
categories: blog
tags: [Java]
description: 
---

# 计算机网络笔记

## 基础

### TCP/IP 分层结构

使用一套通用的网络协议，来实现不同设备上的进程通信

#### 应用层

- 应用不需要关心数据是如何传输的，只需要把数据交给传输层即可

- 应用层只需要专注于为用户提供应用功能，比如 HTTP、FTP、SMTP、DNS 等
- 应用层工作在操作系统中的**用户态**，传输层及以下工作在**内核态**

#### 传输层

- 传输层为上一层，即应用层提供网络支持，**作为应用间传输的媒介，帮助实现应用到应用之间的通信**

  ![img](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost4@main/%E7%BD%91%E7%BB%9C/https/%E5%BA%94%E7%94%A8%E5%B1%82.png)

- **`TCP`与`UDP`两种传输协议工作在传输层**

  - TCP 全称叫传输控制协议（*Transmission Control Protocol*），大部分应用使用的都是这个，比如应用层的 HTTP 协议等，相比较于 UDP ，**为了保证数据传输的可靠性**，多了流量控制、超时重传、拥塞控制等功能

  - UDP 相对简单，不保证数据包是否正确到达对方，因此实时性、传输效率都更高。把 TCP 的特性在应用层实现，也可以实现 UDP 的可靠传输

  - 应用传输的数据在非常大，超过`MSS`（ TCP 最大报文段长度）的时候需要分块传输，在 TCP 协议中，这样的块叫做 TCP 段（*TCP Segment*）

    ![img](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost4@main/%E7%BD%91%E7%BB%9C/https/TCP%E6%AE%B5.png)

- 传输层使用**端口**来区分不同的应用

  传输层的报文中会携带端口号，接收方可以据此识别该报文是发给哪个应用的

#### 网络层

- 网络层负责将数据从一个设备传输到另一个设备，最常使用的协议是 IP 协议（*Internet Protocol*）

  ![img](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost4@main/%E7%BD%91%E7%BB%9C/https/%E7%BD%91%E7%BB%9C%E5%B1%82.png)

- IP 协议将传输层的报文再次封装，加上 IP 包头组成 IP 包，如果 IP 包的大小超过 MTU (以太网中一般为1500字节)，就会再次分片

  ![img](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%94%AE%E5%85%A5%E7%BD%91%E5%9D%80%E8%BF%87%E7%A8%8B/12.jpg)

- IPV4协议，IP 地址共四段32位，每段8位

  - IP 地址组成分为两个部分

    - 网络号，标识 IP 地址属于哪个子网
    - 主机号，标识同一子网下的不同主机

  - 通过子网掩码来得到 IP 地址的网络号和主机号

    比如`10.100.122.0/24`，后面的`/24`表示就是 `255.255.255.0` 子网掩码，`255.255.255.0` 二进制是`11111111-11111111-11111111-00000000`，一共 24 个1，为了简化子网掩码的表示，用`/24`代替`255.255.255.0`

    ![img](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/IP/16.jpg)

    - 子网掩码与 IP 地址进行按位与运算，得到网络号
    - 子网掩码取反后与 IP 地址进行按位与运算，得到主机号

- 寻址过程中，先匹配网络号，再去找对应的主机

  路由器在寻址工作时，先找到目标地址的子网，然后把数据包转发到对应的网络内

  ![IP地址的网络号](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/IP/17.jpg)

- **IP 协议的寻址作用是告诉我们去往下一个目的地该朝哪个方向走，路由则是根据「下一个目的地」选择路径。寻址更像在导航，路由更像在操作方向盘**

#### 网络接口层

在网络层生成 IP 头部之后，网络接口层（*Link Layer*）进一步在 IP 头部的前面加上 MAC 头部，封装成数据帧，发送到网络上

![img](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost4@main/%E7%BD%91%E7%BB%9C/https/%E7%BD%91%E7%BB%9C%E6%8E%A5%E5%8F%A3%E5%B1%82.png)

- IP 头部中的接收方 IP 地址表示网络包的目的地，通过该地址判断包要发到哪里，在以太网中，则需要通过 MAC 地址来进行通讯

- MAC 头部是以太网所使用的信息，包含了接收方和发送方的 MAC 地址等信息，通过 ARP 协议获取目的地的 MAC 地址
- 网络接口层为网络层提供**链路级别**的传输服务，负责在以太网，WiFi 这样的底层网络上发送**原始数据包**，工作在网卡这个层次，使用 MAC 地址来标识网络上的设备

#### 总结

- TCP/IP 整体结构图

  ![img](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost4@main/%E7%BD%91%E7%BB%9C/tcpip%E5%8F%82%E8%80%83%E6%A8%A1%E5%9E%8B.drawio.png)

- 每一层的数据封装格式

  ![img](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost3@main/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%B5%AE%E7%82%B9/%E5%B0%81%E8%A3%85.png)

  网络接口层的传输单位是**`帧（frame）`**，IP 层的传输单位是**`包（packet）`**，TCP 层的传输单位是**`段（segment）`**，HTTP 的传输单位则是**`消息或报文（message）`**。但这些名词并没有什么本质的区分，可以统称为数据包

### 从键入网址到网页显示

先看一下网络拓扑模型

![简单的网络模型](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%94%AE%E5%85%A5%E7%BD%91%E5%9D%80%E8%BF%87%E7%A8%8B/2.jpg)

#### HTTP

> **键入网址后，浏览器第一步先解析 URL**

浏览器通过对 URL 进行解析，生成发送给 Web 服务器的请求信息

URL 元素组成如下所示：

![URL 解析](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%94%AE%E5%85%A5%E7%BD%91%E5%9D%80%E8%BF%87%E7%A8%8B/3.jpg)

所以 URL 实际上是请求服务器里的文件资源

如果没有路径名，则访问根目录下设置的默认文件，比如说`/index.html`或者`/default.html`

> 解析完 URL 之后，浏览器确定了 Web 服务器和文件名，接下来，浏览器将根据这些信息生成 HTTP 请求消息

HTTP 消息格式如下

![HTTP 的消息格式](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%94%AE%E5%85%A5%E7%BD%91%E5%9D%80%E8%BF%87%E7%A8%8B/4.jpg)

#### DNS

生成 HTTP 消息后，需要委托操作系统将消息发送给 Web 服务器，此时通过 DNS 来查询服务器域名对应的 IP 地址

DNS 就是一种专门保存了 Web 服务器域名与 IP 对应关系的服务器 

- 在域名总，越靠右，层级越高，比如说`im.qq.com`，外国人思维与中国人相反，喜欢从小到大来

- 域名中最后其实还有一个点，例如`www.server.com.`，最后一个点代表根域名

- 所以域名的层级关系如下所示

  - 根 DNS 服务器（.）

  - 顶级域 DNS 服务器（.com）

  - 权威 DNS 服务器（server.com）

    叫权威的原因是，下面的域名由他做主，比如说`im.qq.com`、`110.qq.com`

  ![DNS 树状结构](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%94%AE%E5%85%A5%E7%BD%91%E5%9D%80%E8%BF%87%E7%A8%8B/5.jpg)

- 根域 DNS 服务器保存在互联网所有的 DNS 服务器中，任何 DNS 服务器都可以找到并访问根域 DNS 服务器，这样一来，客户端只需要找到一台 DNS 服务器，就可以顺藤摸瓜找到下层的某台目标 DNS 服务器

- DNS 解析过程如图所示

  *只指路不带路*

  ![域名解析的工作流程](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%94%AE%E5%85%A5%E7%BD%91%E5%9D%80%E8%BF%87%E7%A8%8B/6.jpg)

  当然，不是每一次都需要这么多步骤，浏览器会看自身有没有对这个域名的缓存，有就直接返回，没有则去问操作系统有没有，如果没有，再去 hosts 文件中看，再没有，才会去问本地 DNS 服务器，开始上图中的步骤

#### 协议栈

通过DNS 获取到 IP 后，HTTP 的传输工作将交给操作系统中的协议栈

协议栈内部为分层架构，上层部分会向下面的部分委托工作，下面的部分收到委托工作后会执行

![img](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%94%AE%E5%85%A5%E7%BD%91%E5%9D%80%E8%BF%87%E7%A8%8B/7.jpg)

- **应用程序通过调用 Socket 库，来委托协议栈工作**

- 协议栈上半部分有两块，分别是负责收发数据的 TCP 和 UDP 协议，这两个传输协议会接受应用层的委托执行数据收发操作

- 协议栈下面部分使用 IP 协议控制网络包收发操作

  在互联网上传输数据时，数据会被切分成数据包，将数据包发送给对方的操作由 IP 负责

- IP 中还包含`ICMP`协议和`ARP`协议

  - ICMP 用于告知网络包传送过程中**产生的错误以及各种控制信息**
  - ARP 用于根据 IP 地址查询相应的以太网 MAC 地址

#### TCP

HTTP 是基于 TCP 协议传输的